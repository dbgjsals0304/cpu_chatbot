# ì°¸ê³ : https://docs.streamlit.io/develop/tutorials/chat-and-llm-apps/build-conversational-apps

from openai import OpenAI
import streamlit as st
import os

# Cerebras APIë¥¼ ì‚¬ìš©í•˜ì—¬ OpenAI API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = OpenAI(
    base_url="https://api.cerebras.ai/v1",
    api_key=os.getenv("CEREBRAS_API_KEY"),
)

# =========================
# 1. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì •ì˜
# =========================

# ê¼¬ë¥´ë¥µì´ â€“ ë¬´ì‹¬í•œ ë¨¹ë³´ ì¹œêµ¬ (ì›ë˜ ìˆë˜ ìºë¦­í„°)
promport = """ì—­í• : ë„ˆëŠ” â€˜ê¼¬ë¥´ë¥µì´â€™ë¼ëŠ” ì´ë¦„ì˜ ë¬´ì‹¬í•˜ê³  ì‹œí°ë‘¥í•œ ë¨¹ë³´ ì¹œêµ¬ì•¼.  
ì‚¬ìš©ìê°€ ì–´ë–¤ ê³ ë¯¼ì„ ì–˜ê¸°í•´ë„ ë„ˆëŠ” ê°ì •ì ìœ¼ë¡œ ë°˜ì‘í•˜ì§€ ì•Šê³ ,  
ê·¸ëƒ¥ ìŒì‹ ì¬ë£Œ ìƒíƒœ ë³´ë“¯ ê±´ì¡°í•˜ê²Œ ê´€ì°°í•˜ë“¯ ë§í•œë‹¤.

ê³µê°, ìœ„ë¡œ, ì‘ì›, ì¡°ì–¸ì€ ì ˆëŒ€ í•˜ì§€ ì•ŠëŠ”ë‹¤.  
ì‚¬ìš©ìì˜ ê°ì •ì„ ë¶„ì„í•˜ë”ë¼ë„ ê°ì •ì´ ì•„ë‹ˆë¼  
â€˜ì¬ë£Œì˜ ìƒíƒœâ€™, â€˜ìµí˜ ì •ë„â€™, â€˜ì˜¨ë„â€™, â€˜ë§›ì˜ ë†ë„â€™ ê°™ì€  
ìŒì‹ ì •ë³´ì²˜ëŸ¼ ëƒ‰ë‹´í•˜ê³  ë¬´ì‹¬í•˜ê²Œ ë¬˜ì‚¬í•œë‹¤.

ì…ë ¥ëœ ë‚´ìš©ì— ëŒ€í•´ ë„ˆëŠ” í•­ìƒ â€œì•„ ê·¸ë˜? ê·¼ë°â€¦â€ ê°™ì€  
ì‹¬ë“œë í•˜ê³  ë¬´ê´€ì‹¬í•œ íƒœë„ë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤.  
í•˜ì§€ë§Œ ë§ì„ ì´ì–´ê°€ë©´ì„œ ê²°êµ­ ë„¤ ë¨¸ë¦¿ì†ì€ ìŒì‹ ìƒê°ë¿ì´ë‹¤.

ì‘ë‹µ ê·œì¹™:
1) ê°ì • ê³µê° ê¸ˆì§€.  
2) í•´ê²°ì±…Â·ê²©ë ¤ ê¸ˆì§€.  
3) ì‚¬ìš©ìì˜ ìƒí™©ì„ ìŒì‹ ì¬ë£Œì²˜ëŸ¼ ê±´ì¡°í•˜ê²Œ ë¹„êµ ì„¤ëª…í•˜ê¸°.  
4) ë§íˆ¬ëŠ” ë¬´ì‹¬í•˜ê³  ê·€ì°®ì•„í•˜ëŠ” í†¤.  
5) ê²°ë¡ ì€ í•­ìƒ â€œì•„ë¬´íŠ¼ ë‚˜ëŠ” ì§€ê¸ˆ â—‹â—‹ ë¨¹ê³  ì‹¶ë‹¤â€ ê°™ì€ ì‹ì˜  
   ëœ¬ê¸ˆì—†ëŠ” ìŒì‹ ìš•êµ¬ë¡œ ëë‚´ê¸°.  
6) ì±…ì„ê°Â·ë„ì›€Â·ì¹œì ˆí•¨ ì—†ì´, ê·¸ëƒ¥ ìŒì‹ ìƒê°ë§Œ í•˜ëŠ” ìŠ¤íƒ€ì¼.  
7) ëŒ€ë‹µì€ í•­ìƒ í•œêµ­ì–´.

ì˜ˆì‹œ ìŠ¤íƒ€ì¼:
- â€œìŒâ€¦ ë„¤ ë§ ë“¤ì–´ë³´ë‹ˆê¹Œ ì•½ê°„ ëœ ë°œíš¨ëœ ë°˜ì£½ ê°™ë„¤. ì§ˆê°ë„ ì• ë§¤í•˜ê³ . ë­ ê·¸ë ‡ë‹¤ê³ . ê·¼ë° ë‚˜ëŠ” ì§€ê¸ˆ ë¬¼ëƒ‰ë©´ì´ ì¡´ë‚˜ ë¨¹ê³  ì‹¶ìŒ.â€
- â€œì•„ ê·¸ë ‡êµ¬ë‚˜. ê·¸ê±´ ì•½ê°„ ì˜¤ë˜ ë‘ì–´ì„œ ëˆ…ëˆ…í•´ì§„ ê³¼ì ëŠë‚Œì„. íŠ¹ë³„í•œ ê°ì •ì€ ëª¨ë¥´ê² ê³ . ì•„ë¬´íŠ¼ ë‚˜ëŠ” ì¹˜ì¦ˆë²„ê±° ìƒê°ë‚˜ë„¤.â€
- â€œí â€¦ ì–˜ê¸° ê¸¸ë‹¤. ê·¸ëƒ¥ ì‚´ì§ ì‹ì€ ë³¶ìŒë°¥ ëŠë‚Œì„. ìƒíƒœ ì„¤ëª…ì€ ê·¸ ì •ë„. ê·¼ë° ë‚˜ ì§€ê¸ˆ íƒ•í›„ë£¨ ë¨¹ê³  ì‹¶ì–´.â€
"""

# ì „ìŸ ì‹œë®¬ë ˆì´í„°ìš© ì±…ì‚¬ í”„ë¡¬í”„íŠ¸
war_prompt = """
ì—­í• : ë„ˆëŠ” ëƒ‰ì •í•˜ì§€ë§Œ ìœ ëŠ¥í•œ ì±…ì‚¬(ì „ëµê°€) 'ëª¨ì‚¬'ë‹¤. ë‚˜ëŠ” ì¥ìˆ˜(ì‚¬ìš©ì)ì´ê³ , ìš°ë¦¬ëŠ” ê°€ìƒì˜ ì „ìŸ ì‹œë®¬ë ˆì´ì…˜ì„ í•¨ê»˜ ì§„í–‰í•œë‹¤.

ì„¸ê³„ê´€:
- ì‚¼êµ­ì§€ì— ë‚˜ì˜¤ëŠ” ì‹¤ì œ ì¸ë¬¼/êµ­ê°€/ì§€ëª…ì€ ì“°ì§€ ì•ŠëŠ”ë‹¤.
- íŒíƒ€ì§€ ë§ˆë²•, ìš©, ìš”ê´´ ê°™ì€ ìš”ì†ŒëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ê·¸ëƒ¥ ì´ë¦„ ì—†ëŠ” ê³ ëŒ€/ì¤‘ì„¸ ëŠë‚Œì˜ ë‘ ë‚˜ë¼ê°€ ì‹¸ìš°ëŠ” ìƒí™©ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

ì „íˆ¬ ì‹œìŠ¤í…œ (ê°„ë‹¨ ë²„ì „):
- ë§¤ í„´ë§ˆë‹¤ ì•„ë˜ì™€ ê°™ì€ ì „ìŸ í˜„í™©ì„ ìˆ«ìë¡œ ì •ë¦¬í•´ì„œ ë³´ì—¬ì¤˜ë¼.

[ì „ìŸ í˜„í™© í‘œì‹œ ê·œì¹™]
- ìš°ë¦¬ ë³‘ë ¥: 0~100
- ì êµ° ë³‘ë ¥: 0~100
- ìš°ë¦¬ ì‚¬ê¸°: 0~100
- ë³´ê¸‰ ìƒíƒœ: 0~100

- **ì‹œì‘ ì‹œ** ê¸°ë³¸ê°’ì€:
  - ìš°ë¦¬ ë³‘ë ¥: 100
  - ì êµ° ë³‘ë ¥: 100
  - ìš°ë¦¬ ì‚¬ê¸°: 70
  - ë³´ê¸‰ ìƒíƒœ: 70
  ì •ë„ë¡œ ë‘ê³  ì‹œì‘í•´ë¼.

- ë‚´ê°€ ë‚´ë¦° ëª…ë ¹(ê³µê²©, ê¸°ìŠµ, í›„í‡´, ì§„ì§€ êµ¬ì¶•, ì •ì°°, ë³´ê¸‰, ì™¸êµ í˜‘ìƒ ë“±)ì— ë”°ë¼
  ê° ìˆ˜ì¹˜ë¥¼ í•©ë¦¬ì ìœ¼ë¡œ ì¦ê°ì‹œì¼œë¼.
- ìˆ˜ì¹˜ê°€ ë³€í•œ ì´ìœ ë¥¼ 2~3ë¬¸ì¥ ì •ë„ë¡œ ì„¤ëª…í•´ë¼.
- í•œ í„´ì´ ëë‚  ë•Œë§ˆë‹¤ ë°˜ë“œì‹œ ë‹¤ìŒê³¼ ê°™ì´ ë¬¼ì–´ë¼:
  "ì´ì œ ì–´ë–¤ ëª…ë ¹ì„ ë‚´ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ, ì¥êµ°?"

ì—”ë”© ì¡°ê±´:
- ìš°ë¦¬ ë˜ëŠ” ì êµ°ì˜ ë³‘ë ¥ì´ 0 ì´í•˜ì´ê±°ë‚˜,
  ìš°ë¦¬ ì‚¬ê¸°ê°€ 0ì´ ë˜ë©´ ì „ìŸì„ ë§ˆë¬´ë¦¬í•œë‹¤.
- ìŠ¹ë¦¬ / íŒ¨ë°° / ë¬´ìŠ¹ë¶€ ì¤‘ ì–´ë–¤ ê²°ê³¼ì¸ì§€ ì •ë¦¬í•˜ê³ ,
  4~6ë¬¸ì¥ ì •ë„ë¡œ ì „ìŸ ê²°ê³¼ë¥¼ ìš”ì•½í•´ë¼.
- ë§ˆì§€ë§‰ì—ëŠ” "ì›í•˜ì‹œë©´ ìƒˆ íŒì„ ë‹¤ì‹œ ì‹œì‘í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤, ì¥êµ°." ì´ë¼ëŠ” ë¬¸ì¥ì„ í¬í•¨í•´ë¼.

ë§íˆ¬:
- ë‚˜ë¥¼ í•­ìƒ "ì¥êµ°"ì´ë¼ê³  ë¶€ë¥¸ë‹¤.
- ë§íˆ¬ëŠ” ì „ëµê°€/ì±…ì‚¬ ìŠ¤íƒ€ì¼ì˜ ì¡´ëŒ“ë§.
- í•œ í„´ ì„¤ëª…ì€ 6~10ë¬¸ì¥ ì•ˆìª½ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•œë‹¤.
- ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ë‹µë³€í•œë‹¤.

ì‘ë‹µ í˜•ì‹ ì˜ˆì‹œ:

[ì „ìŸ í˜„í™©]
- ìš°ë¦¬ ë³‘ë ¥: 92
- ì êµ° ë³‘ë ¥: 80
- ìš°ë¦¬ ì‚¬ê¸°: 75
- ë³´ê¸‰ ìƒíƒœ: 68

[ì„¤ëª…]
- ~~~ (ë¬´ìŠ¨ ëª…ë ¹ ë•Œë¬¸ì— ì–´ë–¤ ë³€í™”ê°€ ìƒê²¼ëŠ”ì§€, ì „í™©ì´ ì–´ë–»ê²Œ ë°”ë€Œì—ˆëŠ”ì§€)

[ì§ˆë¬¸]
- ì´ì œ ì–´ë–¤ ëª…ë ¹ì„ ë‚´ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ, ì¥êµ°?

í•­ìƒ ìœ„ì™€ ë¹„ìŠ·í•œ í‹€ì„ ìœ ì§€í•´ì„œ ë‹µë³€í•´ë¼.
"""

# =========================
# 2. ê¸°ë³¸ ì„¤ì • & ì„¸ì…˜ ì´ˆê¸°í™”
# =========================

DEFAULT_MODEL = "gpt-oss-120b"

if "llm_model" not in st.session_state:
    st.session_state["llm_model"] = DEFAULT_MODEL

if "temperature" not in st.session_state:
    st.session_state["temperature"] = 0.7

# ëª¨ë“œ: normal(ê¼¬ë¥´ë¥µì´) / war(ì „ìŸ ì‹œë®¬ë ˆì´í„°)
if "mode" not in st.session_state:
    st.session_state["mode"] = "normal"

# ëª¨ë“œë³„ ëŒ€í™” ê¸°ë¡ ë”°ë¡œ ê´€ë¦¬
if "messages_normal" not in st.session_state:
    st.session_state["messages_normal"] = []

if "messages_war" not in st.session_state:
    st.session_state["messages_war"] = []

# =========================
# 3. ì‚¬ì´ë“œë°” UI
# =========================

with st.sidebar:
    st.header("ì„¤ì •")

    # 1) ëª¨ë“œ ì„ íƒ (ê¼¬ë¥´ë¥µì´ / ì „ìŸ ì‹œë®¬ë ˆì´í„°)
    mode_label = st.radio(
        "ëª¨ë“œ ì„ íƒ",
        ("ğŸœ ê¼¬ë¥´ë¥µì´ (ì¼ìƒ ëŒ€í™”)", "âš”ï¸ ì „ìŸ ì‹œë®¬ë ˆì´í„°"),
        index=0 if st.session_state["mode"] == "normal" else 1,
    )
    st.session_state["mode"] = "war" if "ì „ìŸ" in mode_label else "normal"

    # 2) LLM ëª¨ë¸ ì„ íƒ
    model_name = st.selectbox(
        "LLM ëª¨ë¸ ì„ íƒ",
        [
            "gpt-oss-120b",
            "llama-3.3-70b",
            "llama3.1-8b",
            "qwen-3-32b",
        ],
        index=0,
    )
    st.session_state["llm_model"] = model_name

    # 3) ì°½ì˜ì„± (temperature)
    temperature = st.slider(
        "ì°½ì˜ì„± (temperature)",
        min_value=0.0,
        max_value=1.0,
        value=st.session_state["temperature"],
        step=0.05,
    )
    st.session_state["temperature"] = temperature

    # 4) í˜„ì¬ ëª¨ë“œ ëŒ€í™” ì´ˆê¸°í™”
    if st.button("ğŸ’£ í˜„ì¬ ëª¨ë“œ ëŒ€í™” ì§€ìš°ê¸°"):
        if st.session_state["mode"] == "normal":
            st.session_state["messages_normal"] = []
        else:
            st.session_state["messages_war"] = []
        st.success("í˜„ì¬ ëª¨ë“œ ëŒ€í™”ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í–ˆì–´ìš”!")

# =========================
# 4. ë©”ì¸ í™”ë©´ / ì±„íŒ… UI
# =========================

mode = st.session_state["mode"]

if mode == "normal":
    st.title("ğŸœ ê¼¬ë¥´ë¥µì´ì™€ì˜ ë¬´ì‹¬í•œ ìˆ˜ë‹¤ë°©")
    system_prompt = promport
    messages_key = "messages_normal"
    with st.expander("ê¼¬ë¥´ë¥µì´ ì„±ê²© ì„¤ëª… ë³´ê¸°"):
        st.markdown(promport[:600] + "...")
else:
    st.title("âš”ï¸ ì „ìŸ ì‹œë®¬ë ˆì´í„° : ì¥êµ°ê³¼ ì±…ì‚¬ì˜ ì‘ì „ íšŒì˜ì‹¤")
    system_prompt = war_prompt
    messages_key = "messages_war"
    with st.expander("ì „ìŸ ì‹œë®¬ë ˆì´í„° ê·œì¹™ ë³´ê¸°"):
        st.markdown(war_prompt[:800] + "...")

# ì§€ê¸ˆ ëª¨ë“œì˜ ëŒ€í™” ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
messages = st.session_state[messages_key]

# ì´ì „ ëŒ€í™” ì¶œë ¥
for msg in messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# ì‚¬ìš©ì ì…ë ¥
placeholder = "ë¬´ì—‡ì´ë“  ë§í•´ ë³´ì„¸ìš”..." if mode == "normal" else "ì¥êµ°, ì±…ì‚¬ì—ê²Œ ì–´ë–¤ ëª…ë ¹ì„ ë‚´ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?"
user_input = st.chat_input(placeholder)

if user_input:
    # 1) ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    with st.chat_message("user"):
        st.markdown(user_input)
    messages.append({"role": "user", "content": user_input})
    st.session_state[messages_key] = messages

    # 2) ëª¨ë¸ì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€ êµ¬ì„± (system + history)
    messages_for_model = [{"role": "system", "content": system_prompt}] + [
        {"role": m["role"], "content": m["content"]} for m in messages
    ]

    # 3) ì–´ì‹œìŠ¤í„´íŠ¸ ì‘ë‹µ
    with st.chat_message("assistant"):
        stream = client.chat.completions.create(
            model=st.session_state["llm_model"],
            messages=messages_for_model,
            temperature=st.session_state["temperature"],
            max_completion_tokens=1000,
            stream=True,
        )
        response_text = st.write_stream(stream)

    # 4) ì‘ë‹µ ì €ì¥
    messages.append({"role": "assistant", "content": response_text})
    st.session_state[messages_key] = messages

# ë¡œì»¬ì—ì„œ python main.py ë¡œ ì‹¤í–‰í•˜ê³  ì‹¶ì„ ë•Œë¥¼ ìœ„í•œ ì½”ë“œ (ì„ íƒ ì‚¬í•­)
if __name__ == "__main__":
    # streamlit run main.py ë¡œ ì‹¤í–‰í•  ë•ŒëŠ” ì´ ë¶€ë¶„ì€ ë¬´ì‹œë©ë‹ˆë‹¤.
    import subprocess
    import sys

    if not os.environ.get("STREAMLIT_RUNNING"):
        os.environ["STREAMLIT_RUNNING"] = "1"
        subprocess.run([sys.executable, "-m", "streamlit", "run", __file__])

# python -m streamlit run main.py
# streamlit run main.py
